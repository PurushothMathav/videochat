<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PeerJS 1-to-1 Video Chat</title>
  <style>
    body { background: #222; color: #fff; font-family: Arial, sans-serif; }
    .container { max-width: 600px; margin: 40px auto; padding: 24px; background: #333; border-radius: 10px; }
    video { width: 100%; max-width: 320px; background: #000; border-radius: 8px; }
    .videos { display: flex; gap: 20px; justify-content: center; margin: 20px 0; }
    input, button { padding: 8px; border-radius: 4px; border: none; margin: 0 5px; }
    button { background: #ff4500; color: #fff; cursor: pointer; }
    .link { background: #111; color: #fff; padding: 8px; border-radius: 4px; word-break: break-all; }
  </style>
</head>
<body>
  <div class="container">
    <h2>PeerJS 1-to-1 Video Chat</h2>
    <div id="step1">
      <button id="startBtn">Start Video Chat</button>
    </div>
    <div id="step2" style="display:none;">
      <div id="hostInfo" style="display:none;">
        <p>Share this link with your friend:</p>
        <div class="link" id="shareLink"></div>
      </div>
      <div id="guestInfo" style="display:none;">
        <p>Connecting to host...</p>
      </div>
      <div class="videos">
        <div>
          <div style="text-align:center;">You</div>
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div>
          <div style="text-align:center;">Remote</div>
          <video id="remoteVideo" autoplay playsinline></video>
        </div>
      </div>
      <button id="endBtn">End Call</button>
    </div>
  </div>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const startBtn = document.getElementById('startBtn');
    const endBtn = document.getElementById('endBtn');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const hostInfo = document.getElementById('hostInfo');
    const guestInfo = document.getElementById('guestInfo');
    const shareLink = document.getElementById('shareLink');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    let peer, localStream, call, isHost = false;

    async function getMedia() {
      return await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    }

    startBtn.onclick = async () => {
      step1.style.display = 'none';
      step2.style.display = '';
      localStream = await getMedia();
      localVideo.srcObject = localStream;

      // Check if joining as guest (with ?host=peerid)
      const urlParams = new URLSearchParams(window.location.search);
      const hostId = urlParams.get('host');
      if (hostId) {
        // Guest
        guestInfo.style.display = '';
        peer = new Peer();
        peer.on('open', id => {
          call = peer.call(hostId, localStream);
          call.on('stream', stream => {
            remoteVideo.srcObject = stream;
          });
        });
        peer.on('call', incomingCall => {
          incomingCall.answer(localStream);
        });
      } else {
        // Host
        isHost = true;
        hostInfo.style.display = '';
        peer = new Peer();
        peer.on('open', id => {
          shareLink.textContent = `${window.location.origin}${window.location.pathname}?host=${id}`;
        });
        peer.on('call', incomingCall => {
          incomingCall.answer(localStream);
          incomingCall.on('stream', stream => {
            remoteVideo.srcObject = stream;
          });
          call = incomingCall;
        });
      }
    };

    endBtn.onclick = () => {
      if (call) call.close();
      if (peer) peer.destroy();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      window.location.href = window.location.pathname; // reload to reset
    };
  </script>
</body>
</html>
