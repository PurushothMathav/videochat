<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PeerJS 1-to-1 Video Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background: #222; color: #fff; font-family: Arial, sans-serif; margin: 0; }
    .container { max-width: 700px; margin: 40px auto; padding: 24px; background: #333; border-radius: 14px; box-shadow: 0 4px 24px #0004; }
    h2 { margin-top: 0; }
    .share-row { display: flex; gap: 8px; align-items: center; margin-bottom: 18px; }
    .share-link-input {
      flex: 1;
      padding: 10px;
      border-radius: 6px;
      border: none;
      background: #181818;
      color: #fff;
      font-size: 15px;
      outline: none;
    }
    .copy-btn {
      background: #ff4500;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 16px;
      font-size: 15px;
      cursor: pointer;
    }
    .videos {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
      margin: 18px 0;
    }
    .video-box {
      background: #111;
      border-radius: 10px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .video-label {
      margin-bottom: 6px;
      font-size: 15px;
      color: #bbb;
    }
    video {
      width: 100%;
      aspect-ratio: 4/3;
      background: #000;
      border-radius: 8px;
      max-height: 260px;
      object-fit: cover;
    }
    .controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .ctrl-btn {
      background: #ff4500;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      min-width: 90px;
      transition: background 0.2s;
    }
    .ctrl-btn.off {
      background: #555;
      color: #fff;
    }
    @media (max-width: 700px) {
      .container { max-width: 98vw; padding: 8px; }
      .videos { grid-template-columns: 1fr; gap: 12px; }
      video { max-height: 40vw; }
      .ctrl-btn { font-size: 15px; padding: 10px 0; min-width: 80px; }
    }
    @media (max-width: 400px) {
      .ctrl-btn { font-size: 14px; padding: 8px 0; min-width: 70px; }
      video { max-height: 32vw; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>PeerJS 1-to-1 Video Chat</h2>
    <div id="step1">
      <button class="ctrl-btn" id="startBtn">Start Video Chat</button>
    </div>
    <div id="step2" style="display:none;">
      <div id="hostInfo" style="display:none;">
        <p>Share this link with your friend:</p>
        <div class="share-row">
          <input id="shareLink" class="share-link-input" readonly>
          <button class="copy-btn" id="copyBtn">Copy</button>
        </div>
      </div>
      <div id="guestInfo" style="display:none;">
        <p>Connecting to host...</p>
      </div>
      <div class="videos">
        <div class="video-box">
          <div class="video-label">You</div>
          <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div class="video-box">
          <div class="video-label">Remote</div>
          <video id="remoteVideo" autoplay playsinline></video>
        </div>
      </div>
      <div class="controls">
        <button id="micBtn" class="ctrl-btn">Mic On</button>
        <button id="camBtn" class="ctrl-btn">Cam On</button>
        <button id="endBtn" class="ctrl-btn">End Call</button>
      </div>
    </div>
  </div>
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
    const startBtn = document.getElementById('startBtn');
    const endBtn = document.getElementById('endBtn');
    const micBtn = document.getElementById('micBtn');
    const camBtn = document.getElementById('camBtn');
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const hostInfo = document.getElementById('hostInfo');
    const guestInfo = document.getElementById('guestInfo');
    const shareLink = document.getElementById('shareLink');
    const copyBtn = document.getElementById('copyBtn');
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');

    let peer, localStream, call, isHost = false;
    let micOn = true, camOn = true;

    async function getMedia() {
      return await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    }

    startBtn.onclick = async () => {
      step1.style.display = 'none';
      step2.style.display = '';
      localStream = await getMedia();
      localVideo.srcObject = localStream;

      // Check if joining as guest (with ?host=peerid)
      const urlParams = new URLSearchParams(window.location.search);
      const hostId = urlParams.get('host');
      if (hostId) {
        guestInfo.style.display = '';
        peer = new Peer();
        peer.on('open', id => {
          call = peer.call(hostId, localStream);
          call.on('stream', stream => {
            remoteVideo.srcObject = stream;
          });
        });
        peer.on('call', incomingCall => {
          incomingCall.answer(localStream);
        });
      } else {
        isHost = true;
        hostInfo.style.display = '';
        peer = new Peer();
        peer.on('open', id => {
          shareLink.value = `${window.location.origin}${window.location.pathname}?host=${id}`;
        });
        peer.on('call', incomingCall => {
          incomingCall.answer(localStream);
          incomingCall.on('stream', stream => {
            remoteVideo.srcObject = stream;
          });
          call = incomingCall;
        });
      }
    };

    micBtn.onclick = () => {
      micOn = !micOn;
      localStream.getAudioTracks().forEach(track => track.enabled = micOn);
      micBtn.textContent = micOn ? 'Mic On' : 'Mic Off';
      micBtn.className = micOn ? 'ctrl-btn' : 'ctrl-btn off';
    };

    camBtn.onclick = () => {
      camOn = !camOn;
      localStream.getVideoTracks().forEach(track => track.enabled = camOn);
      camBtn.textContent = camOn ? 'Cam On' : 'Cam Off';
      camBtn.className = camOn ? 'ctrl-btn' : 'ctrl-btn off';
    };

    endBtn.onclick = () => {
      if (call) call.close();
      if (peer) peer.destroy();
      if (localStream) localStream.getTracks().forEach(t => t.stop());
      window.location.href = window.location.pathname; // reload to reset
    };

    // Easy copy for mobile/desktop
    copyBtn.onclick = () => {
      shareLink.select();
      shareLink.setSelectionRange(0, 99999);
      document.execCommand('copy');
      copyBtn.textContent = 'Copied!';
      setTimeout(() => copyBtn.textContent = 'Copy', 1200);
    };
    // On tap, select all for easy manual copy
    shareLink.onclick = () => {
      shareLink.select();
      shareLink.setSelectionRange(0, 99999);
    };
  </script>
</body>
</html>
